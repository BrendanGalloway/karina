# Source: keptn/charts/control-plane/charts/nats/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keptn-nats-cluster
  labels:
    app: keptn-nats-cluster
    chart: nats-0.4.2
spec:
  selector:
    matchLabels:
      app: keptn-nats-cluster
  replicas: 1
  serviceName: keptn-nats-cluster
  template:
    metadata:
      labels:
        app: keptn-nats-cluster
        chart: nats-0.4.2
    spec:
      # Common volumes for the containers.
      volumes:
        - name: config-volume
          configMap:
            name: keptn-nats-cluster-config
        # Local volume shared with the reloader.
        - name: pid
          emptyDir: {}
      #################
      #               #
      #  TLS Volumes  #
      #               #
      #################

      # Required to be able to HUP signal and apply config
      # reload to the server without restarting the pod.
      shareProcessNamespace: true
      #################
      #               #
      #  NATS Server  #
      #               #
      #################
      terminationGracePeriodSeconds: 60
      containers:
        - name: nats
          image: nats:2.1.7-alpine3.11
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 4222
              name: client
            - containerPort: 7422
              name: leafnodes
            - containerPort: 7522
              name: gateways
            - containerPort: 6222
              name: cluster
            - containerPort: 8222
              name: monitor
            - containerPort: 7777
              name: metrics
          command:
            - "nats-server"
            - "--config"
            - "/etc/nats-config/nats.conf"
          # Required to be able to define an environment variable
          # that refers to other environment variables.  This env var
          # is later used as part of the configuration file.
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CLUSTER_ADVERTISE
              value: $(POD_NAME).keptn-nats-cluster.$(POD_NAMESPACE).svc
          volumeMounts:
            - name: config-volume
              mountPath: /etc/nats-config
            - name: pid
              mountPath: /var/run/nats
              #######################
              #                     #
              #  TLS Volumes Mounts #
              #                     #
              #######################
          # Liveness/Readiness probes against the monitoring.
          #
          livenessProbe:
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            timeoutSeconds: 5
          # Gracefully stop NATS Server on pod deletion or image upgrade.
          #
          lifecycle:
            preStop:
              exec:
                # Using the alpine based NATS image, we add an extra sleep that is
                # the same amount as the terminationGracePeriodSeconds to allow
                # the NATS Server to gracefully terminate the client connections.
                #
                command: ["/bin/sh", "-c", "nats-server -sl=ldm=/var/run/nats/nats.pid && /bin/sleep 60"]
        #################################
        #                               #
        #  NATS Configuration Reloader  #
        #                               #
        #################################
        - name: reloader
          image: connecteverything/nats-server-config-reloader:0.6.0
          imagePullPolicy: IfNotPresent
          command:
            - "nats-server-config-reloader"
            - "-pid"
            - "/var/run/nats/nats.pid"
            - "-config"
            - "/etc/nats-config/nats.conf"
          volumeMounts:
            - name: config-volume
              mountPath: /etc/nats-config
            - name: pid
              mountPath: /var/run/nats
        ##############################
        #                            #
        #  NATS Prometheus Exporter  #
        #                            #
        ##############################
        - name: metrics
          image: synadia/prometheus-nats-exporter:0.5.0
          imagePullPolicy: IfNotPresent
          args:
            - -connz
            - -routez
            - -subz
            - -varz
            - -prefix=nats
            - -use_internal_server_id
            - http://localhost:8222/
          ports:
            - containerPort: 7777
              name: metrics
