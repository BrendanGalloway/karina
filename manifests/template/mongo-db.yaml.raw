apiVersion: templating.flanksource.com/v1
kind: Template
metadata:
  name: mongo-db
spec:
  source:
    apiVersion: db.flanksource.com/v1
    kind: MongoDB
  resources:
    - apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: mongodb-{{ .metadata.name }}
        namespace: '{{ .metadata.namespace }}'
      spec:
        replicas: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: mongodb
            app.kubernetes.io/instance: '{{ .metadata.name }}'
        strategy:
          type: Recreate
        template:
          metadata:
            labels:
              app.kubernetes.io/name: mongodb
              app.kubernetes.io/instance: '{{ .metadata.name }}'
          spec:
            securityContext:
              fsGroup: 184
            containers:
              - image: docker.io/centos/mongodb-36-centos7:1
                name: mongodb
                env:
                  - name: MONGODB_DATABASE
                    value: "mongo"
                  - name: MONGODB_USER
                    value: "mongouser"
                  - name: MONGODB_PASSWORD
                    value: "mongouserpassword"
                  - name: MONGODB_ADMIN_PASSWORD
                    value: "mongoadminpassword"
                ports:
                  - containerPort: 27017
                resources:
                  requests:
                    memory: '{{ .spec.memory | default "64Mi" }}'
                    cpu: '{{ .spec.cpu | default "50m" }}'
                  limits:
                    memory: '{{ .spec.memory | default "300Mi" }}'
                    cpu: '{{ .spec.cpu | default "100m" }}'
                volumeMounts:
                  - mountPath: /var/lib/mongodb/data
                    name: mongodata
            restartPolicy: Always
            volumes:
              - name: mongodata
                persistentVolumeClaim:
                  claimName: mongodata-{{ .metadata.name }}

    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "mongodata-{{ .metadata.name }}"
        namespace: '{{ .metadata.namespace }}'
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: '{{ .spec.storage.size | default "5Gi" }}'

    - apiVersion: v1
      kind: Service
      metadata:
        name: "mongodb-{{ .metadata.name }}"
        namespace: '{{ .metadata.namespace }}'
      spec:
        ports:
        - name: "27017"
          port: 27017
          targetPort: 27017
        selector:
          app.kubernetes.io/name: mongodb
          app.kubernetes.io/instance: '{{ .metadata.name }}'